<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>產業服務鏈（RWD＋Firestore＋去重＋C/B分類＋新增鏈）</title>
  <style>
    :root{
      --bg:#eef2e6; --ink:#0f172a; --muted:#6b7280; --card:#ffffff; --br:#e5e7eb; --shadow:0 10px 30px rgba(0,0,0,.06);
      --pill:#111; --pill-ink:#fff; --pill-sec-bg:#fff; --pill-sec-ink:#111;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,"Noto Sans TC","PingFang TC",sans-serif;line-height:1.4}
    .container{max-width:1280px;margin:0 auto;padding:14px 12px 56px}
    .toolbar-wrap{position:sticky;top:0;z-index:50;background:linear-gradient(#eef2e6,#eef2e6cc 60%,#eef2e600);backdrop-filter:saturate(120%) blur(6px)}
    .toolbar{display:flex;gap:6px;align-items:center;flex-wrap:wrap;padding:6px 0}
    .btn{padding:6px 10px;border:1px solid var(--br);border-radius:6px;background:var(--pill);color:var(--pill-ink);cursor:pointer;box-shadow:var(--shadow);font-size:13px}
    .btn.secondary{background:var(--pill-sec-bg);color:var(--pill-sec-ink)}
    .btn.ghost{background:transparent}
    h1{margin:14px 0 8px 0;font-size:24px;letter-spacing:.5px;text-align:center}
    .stats{margin-left:auto;font-weight:800;white-space:nowrap;font-size:13px}
    .wrap.editable header,.wrap.editable .body{outline:2px dashed #93c5fd;background:#f0f9ff}
    .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin:14px 0}
    .card{border:1px solid var(--br);border-radius:16px;overflow:hidden;background:var(--card);box-shadow:var(--shadow);position:relative}
    .hdr{padding:8px 12px;color:#fff;font-weight:900;letter-spacing:.6px;font-size:15px}
    header .del-chain{position:absolute;right:6px;top:6px;border:none;background:#ef4444;color:#fff;border-radius:6px;padding:0 6px;cursor:pointer;display:none;font-size:12px}
    .wrap.editable header .del-chain{display:inline-block}
    header[contenteditable="true"] .del-chain{display:inline-block}
    /* 顏色塊 */
    header.hdr1{background:#f59e0b} header.hdr2{background:#6366f1} header.hdr3{background:#6b7280}
    header.hdr4{background:#10b981} header.hdr5{background:#f97316} header.hdr6{background:#ef4444}
    header.hdr7{background:#14b8a6} header.hdr8{background:#8b5cf6} header.hdr9{background:#22c55e}
    header.hdr10{background:#0ea5e9} header.hdr11{background:#d946ef} header.hdr12{background:#94a3b8}
    .body{padding:8px 12px;min-height:120px}
    ul{list-style:none;margin:0;padding:0}
    li{padding:6px 0;position:relative;border-bottom:1px dashed #e5e7eb;font-size:13px}
    li:last-child{border-bottom:0}
    li.hot{color:#b91c1c;font-weight:600}
    .li-x{position:absolute;right:0;top:4px;border:0;background:#ef4444;color:#fff;border-radius:6px;padding:0 6px;cursor:pointer;display:none;font-size:12px}
    .wrap.editable li .li-x{display:inline-block}
    .add-item{margin-top:6px;border:1px dashed #bbb;background:#fff;border-radius:6px;padding:4px 8px;cursor:pointer;width:100%;font-size:12px}
    .meta{padding:6px 8px;border-top:1px solid #eee;background:#fafafa;font-size:11px;color:#475569;display:flex;gap:6px;flex-wrap:wrap}
    .meta .chip{display:inline-block;padding:0 6px;border:1px solid var(--br);border-radius:999px;font-weight:700;font-size:11px}
    .meta .chip.warn{border-color:#fecaca;color:#b91c1c}
    .meta .chip.total{border-color:#dbeafe}
    li .cat-chip{display:inline-block;margin-left:6px;padding:0 4px;border:1px solid #d1d5db;border-radius:999px;font-size:10px}
    li.cat-c .cat-chip{border-color:#dbeafe;background:#eff6ff;color:#1d4ed8}
    li.cat-b .cat-chip{border-color:#fde68a;background:#fffbeb;color:#b45309}
    .note{color:var(--muted);font-size:11px;text-align:center;margin-top:4px}
  </style>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-app.js";
    import { getFirestore } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBfGL-GcBiTDANBbPxsbAPSn42gqkQAn4M",
      authDomain: "contacts-sphere.firebaseapp.com",
      projectId: "contacts-sphere",
      storageBucket: "contacts-sphere.firebasestorage.app",
      messagingSenderId: "612743466240",
      appId: "1:612743466240:web:72235bb15559d3297f77e5",
      measurementId: "G-HB4GEF8JMM"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // 暴露 Firestore 實例給下方非 module 腳本使用
    window.firestoreDB = db;
  </script>
</head>
<body>
  <div class="container">
    <div class="toolbar-wrap">
      <div class="toolbar">
        <button class="btn" id="cloudSave">雲端備份</button>
        <button class="btn secondary" id="cloudLoad">雲端載入</button>
        <button class="btn" id="toggleEdit">切換編輯模式</button>
        <button class="btn secondary" id="toggleHot">切換紅/黑</button>
        <button class="btn ghost" id="recalcBtn">重算統計</button>
        <button class="btn" id="exportPdf">匯出 PDF</button>
        <button class="btn" id="openImporter">匯入舊版資料</button>
        <button class="btn" id="addChain">＋ 新增服務鏈</button>
        <span class="stats">會員 <span id="mAll">0</span>｜邀約 <span id="nAll">0</span>｜合計 <span id="tAll">0</span></span>
      </div>
    </div>
    <h1 id="pageTitle">富新分會 產業服務鏈</h1>
    <div class="wrap" id="wrap">
      <section class="grid" id="grid"></section>
    </div>
  </div>

  <script>
  (function(){
    var wrap=document.getElementById('wrap');
    var grid=document.getElementById('grid');
    var mAll=document.getElementById('mAll');
    var nAll=document.getElementById('nAll');
    var tAll=document.getElementById('tAll');
    var lastClickedLi=null;

    // 動態載入 Firestore v9 模組（確保非 module 腳本能使用 doc/getDoc/setDoc）
    var _fsMod=null; 
    async function ensureFS(){
      if(_fsMod) return _fsMod;
      _fsMod = await import('https://www.gstatic.com/firebasejs/9.6.11/firebase-firestore.js');
      return _fsMod;
    }

    function toArray(nl){return Array.prototype.slice.call(nl||[],0);} 
    function inferCatFromText(txt){ if(!txt) return ''; if(/^\s*C端[:：]/.test(txt)) return 'C'; if(/^\s*B端[:：]/.test(txt)) return 'B'; return ''; }
    function renderCatChip(li, cat){ var old=li.querySelector('.cat-chip'); if(old) old.remove(); li.classList.remove('cat-c','cat-b'); if(cat==='C'||cat==='B'){ var chip=document.createElement('span'); chip.className='cat-chip'; chip.textContent=(cat==='C'?'C端':'B端'); li.appendChild(chip); li.classList.add(cat==='C'?'cat-c':'cat-b'); } }
    function bindCatToggle(li){ li.addEventListener('contextmenu',function(e){ e.preventDefault(); var cur=li.getAttribute('data-cat')||inferCatFromText((li.childNodes[0]&&li.childNodes[0].textContent)||''); var next=(cur===''?'C':(cur==='C'?'B':'')); li.setAttribute('data-cat',next); renderCatChip(li,next); }); }

    async function cloudSave(){
      try{
        var chains=[]; var cards=toArray(document.querySelectorAll('.card'));
        cards.forEach(function(card){
          var title=(card.querySelector('header')||{}).textContent.trim();
          var items=[]; card.querySelectorAll('li').forEach(function(li){ items.push({ text:li.childNodes[0].textContent.trim(), need:li.classList.contains('hot'), cat:li.getAttribute('data-cat')||'' }); });
          chains.push({ title:title, items:items });
        });
        var branchTitle = (document.getElementById('pageTitle')||{}).textContent.trim();
        if(!window.firestoreDB) throw new Error('Firebase 未初始化');
        const { doc, setDoc } = await ensureFS();
        await setDoc(doc(window.firestoreDB,'fuXinChains','main'), { branchTitle: branchTitle, chains:chains, ts:Date.now() }, { merge:true });
        alert('已儲存到雲端');
      }catch(err){ alert('雲端備份失敗：'+err.message); }
    }

    async function cloudLoad(){
      try{
        if(!window.firestoreDB) throw new Error('Firebase 未初始化');
        const { doc, getDoc } = await ensureFS();
        const snap = await getDoc(doc(window.firestoreDB,'fuXinChains','main'));
        if(snap.exists()){
          const data=snap.data();
          if(data.branchTitle){ (document.getElementById('pageTitle')||{}).textContent = data.branchTitle; }
          renderChains(Array.isArray(data.chains)? data.chains : []);
          alert('已自雲端載入並覆蓋畫面');
        }else{
          alert('雲端沒有資料');
        }
      }catch(err){ alert('雲端載入失敗：'+err.message); }
    }

    function renderChains(chains){
      grid.innerHTML='';
      chains.forEach(function(chain,idx){
        var art=document.createElement('article'); art.className='card';
        var hdr=document.createElement('header'); hdr.className='hdr hdr'+(((idx%12)+1)); hdr.textContent=chain.title||''; art.appendChild(hdr);
        var body=document.createElement('div'); body.className='body';
        var ul=document.createElement('ul');
        (chain.items||[]).forEach(function(it){
          var li=document.createElement('li'); if(it.need) li.classList.add('hot'); if(it.cat) li.setAttribute('data-cat',it.cat);
          li.textContent=it.text||'';
          var x=document.createElement('button'); x.className='li-x'; x.textContent='×'; x.addEventListener('click',function(e){ e.preventDefault(); if(!wrap.classList.contains('editable')) return; li.remove(); updateStats(); }); li.appendChild(x);
          ul.appendChild(li);
        });
        body.appendChild(ul);
        var addBtn=document.createElement('button'); addBtn.className='add-item'; addBtn.textContent='＋ 新增項目'; body.appendChild(addBtn);
        art.appendChild(body); grid.appendChild(art);
      });
      refreshDeleteButtons(); wireAddButtons(); updateStats();
    }

    function refreshDeleteButtons(){
      var lis=toArray(document.querySelectorAll('li'));
      lis.forEach(function(li){
        if(!li.querySelector('.li-x')){
          var x=document.createElement('button'); x.className='li-x'; x.title='刪除'; x.textContent='×';
          x.addEventListener('click',function(e){ e.preventDefault(); if(!wrap.classList.contains('editable')) return; li.remove(); updateStats(); });
          li.appendChild(x);
        }
        bindCatToggle(li);
        li.onclick=function(e){ if(e.target.classList.contains('li-x')) return; lastClickedLi=li; if(!wrap.classList.contains('editable')) return; li.classList.toggle('hot'); updateStats(); };
        var catAttr=li.getAttribute('data-cat')||inferCatFromText((li.childNodes[0]&&li.childNodes[0].textContent)||'');
        if(catAttr){ li.setAttribute('data-cat',catAttr); renderCatChip(li,catAttr); }
      });

      var chains=toArray(document.querySelectorAll('.card'));
      chains.forEach(function(card){
        if(!card.querySelector('.del-chain')){
          var del=document.createElement('button'); del.className='del-chain'; del.textContent='×';
          del.addEventListener('click',function(){ if(!wrap.classList.contains('editable')) return; card.remove(); updateStats(); });
          (card.querySelector('header')||card).appendChild(del);
        }
      });
    }

    function wireAddButtons(){
      var adds=toArray(document.querySelectorAll('.add-item'));
      adds.forEach(function(btn){
        btn.onclick=function(e){ e.preventDefault(); if(!wrap.classList.contains('editable')) return;
          var txt=prompt('輸入新項目'); if(!txt) return;
          var li=document.createElement('li'); li.className='editable-target'; if(/^\s*(需要邀約|邀約)[:：]/.test(txt)) li.classList.add('hot');
          li.textContent=txt;
          var x=document.createElement('button'); x.className='li-x'; x.textContent='×'; x.addEventListener('click',function(ev){ ev.preventDefault(); if(!wrap.classList.contains('editable')) return; li.remove(); updateStats(); }); li.appendChild(x);
          btn.parentNode.querySelector('ul').appendChild(li);
          var cat=inferCatFromText(txt); if(cat){ li.setAttribute('data-cat',cat); renderCatChip(li,cat); }
          bindCatToggle(li); updateStats(); };
      });
    }

    function updateStats(){
      var cards=toArray(document.querySelectorAll('.card'));
      var allTotal=0,allNeed=0;
      cards.forEach(function(card){
        var lis=toArray(card.querySelectorAll('li'));
        var needLis=lis.filter(function(li){return li.classList.contains('hot')});
        var memCount=lis.length-needLis.length; var totCount=lis.length; allTotal+=totCount; allNeed+=needLis.length;
        var meta=card.querySelector('.meta'); if(!meta){ meta=document.createElement('div'); meta.className='meta'; card.appendChild(meta);} 
        meta.innerHTML='<span class="chip">會員 '+memCount+'</span><span class="chip warn">邀約 '+needLis.length+'</span><span class="chip total">合計 '+totCount+'</span>';
      });
      mAll.textContent=(allTotal-allNeed); nAll.textContent=allNeed; tAll.textContent=allTotal;
    }

    function setEditable(on){
      if(on){
        wrap.classList.add('editable');
        toArray(document.querySelectorAll('header, li, #pageTitle')).forEach(function(el){ el.setAttribute('contenteditable','true'); });
      } else {
        wrap.classList.remove('editable');
        toArray(document.querySelectorAll('header, li, #pageTitle')).forEach(function(el){ el.removeAttribute('contenteditable'); });
      }
      refreshDeleteButtons();
    }

    // === Buttons ===
    document.getElementById('toggleEdit').onclick=function(){
      if(!wrap.classList.contains('editable')){ var pin=prompt(''); if(pin==='2614'){ setEditable(true);} else if(pin!==null){ alert('密碼錯誤'); } }
      else { setEditable(false); }
    };
    document.getElementById('recalcBtn').onclick=function(){ updateStats(); };
    document.getElementById('toggleHot').onclick=function(){ if(!wrap.classList.contains('editable')) return; if(!lastClickedLi){ alert('先點一下要切換的項目'); return;} lastClickedLi.classList.toggle('hot'); updateStats(); };

    document.getElementById('addChain').onclick=function(){
      if(!wrap.classList.contains('editable')) return;
      var title=prompt('輸入新服務鏈標題'); if(!title) return;
      var idx=document.querySelectorAll('.card').length+1;
      var art=document.createElement('article'); art.className='card';
      var hdr=document.createElement('header'); hdr.className='hdr hdr'+(((idx%12)+1)); hdr.textContent=title; art.appendChild(hdr);
      var body=document.createElement('div'); body.className='body';
      var ul=document.createElement('ul'); body.appendChild(ul);
      var addBtn=document.createElement('button'); addBtn.className='add-item'; addBtn.textContent='＋ 新增項目'; body.appendChild(addBtn);
      art.appendChild(body); grid.appendChild(art);
      refreshDeleteButtons(); wireAddButtons(); updateStats();
    };

    document.getElementById('exportPdf').onclick=function(){
      var wasEditable=wrap.classList.contains('editable');
      if(wasEditable) setEditable(false);
      updateStats();
      setTimeout(function(){ window.print(); },50);
      setTimeout(function(){ if(wasEditable) setEditable(true); },600);
    };

    document.getElementById('cloudSave').onclick=cloudSave;
    document.getElementById('cloudLoad').onclick=cloudLoad;

    // 初始：沒有雲端資料時給一張示例卡；若要開啟就自動載入，取消下一行註解
    renderChains([{ title:'房屋軟裝設計產業鏈', items:[{text:'住宅室內設計'},{text:'需要邀約：木地板工程', need:true}] }]);
    // document.getElementById('cloudLoad').click();

    // ====== 簡易測試（不影響使用），結果請看 Console ======
    try{
      console.log('[TEST] start');
      console.assert(inferCatFromText('C端：家電')==='C','C端判斷錯誤');
      console.assert(inferCatFromText('B端：工程')==='B','B端判斷錯誤');
      // 初始示例卡：2 筆，其中 1 筆 hot
      console.assert(parseInt(document.getElementById('mAll').textContent,10)>=1,'會員數應 >=1');
      console.assert(parseInt(document.getElementById('nAll').textContent,10)>=1,'邀約數應 >=1');
      console.assert(parseInt(document.getElementById('tAll').textContent,10)>=2,'合計應 >=2');
      // 可進出編輯模式
      setEditable(true);  console.assert(wrap.classList.contains('editable'),'進入編輯失敗');
      setEditable(false); console.assert(!wrap.classList.contains('editable'),'退出編輯失敗');
      console.log('[TEST] all passed');
    }catch(e){ console.warn('[TEST] failed', e); }

  })();
  </script>
</body>
</html>
